<div class="container">
  <div class="row">
    <div class="col-md-8 offset-2">
      <% flash.each do |message_type, msg| %>
        <div class="mt-4 alert alert-<%= message_type %>"><%= msg %></div>
      <% end %>
      <h3 class="mt-5 mb-4 text-center"><%= @store.store_name %>の編集</h3>
        <hr>
        <div class="jumbotron">
          <div class="form_group">
            <%= form_with(model: @store, url: store_manager_store_path(@store), method: :patch, local: true) do |sf| %>
              <%= render "shared/error_messages", object: sf.object %>
              <div class="field mt-3">
                <%= sf.label :store_name, class:"mr-2"%><span class="badge badge-danger">必須</span>
                <%= sf.text_field :store_name, class:"form-control" %>
              </div>

              <div class="field mt-3">
                <%= sf.label :adress, class:"mr-2" %>
                <%= sf.text_field :adress,placeholder: "例）東京都墨田区押上１丁目１−２", class:"form-control" %>
              </div>

              <div class="field mt-3">
                <%= sf.label :store_phonenumber, class:"mr-2" %>
                <%= sf.text_field :store_phonenumber, placeholder: "例）012-3456-7890", class:"form-control" %>
              </div>

              <div class="field mt-3">
                <%= sf.label :store_description, class:"mr-2" %>
                <%= sf.text_area :store_description, class:"form-control" %>
              </div>

              <div class="field mt-3">
                <% unless @store.store_images.pluck(:store_image).any? %>
                  <% if @store.store_images.where(store_image: nil).present? %>
                    <%= sf.fields_for :store_images do |sif| %>
                      <div class="post__drop__box__container">
                        <div class="prev-content"></div>
                        <div class="label-content">
                          <label class="label-box" for="store_img_field_0" id="label-box--0">
                            <pre class="label-box__text-visible">クリックしてファイルをアップロード/画像なしnil</pre>
                          </label><br>
                          <div class="hidden_field">
                            <%= sif.file_field :store_image, id: :store_img_field_0, multiple: true %>
                            <%= sif.file_field :store_image, id: :store_img_field_1, multiple: true %>
                            <%= sif.file_field :store_image, id: :store_img_field_2, multiple: true %>
                            <%= sif.file_field :store_image, id: :store_img_field_3, multiple: true %>
                            <%= sif.file_field :store_image, id: :store_img_field_4, multiple: true %>
                          </div>
                          <hr>
                        </div>
                      </div>
                    <% end %>
                  <% else %>
                      <%= sf.fields_for :store_images, @store.store_images.build do |sif| %>
                        <div class="post__drop__box__container">
                          <div class="prev-content"></div>
                          <div class="label-content">
                            <label class="label-box" for="store_img_field_0" id="label-box--0">
                              <pre class="label-box__text-visible">クリックしてファイルをアップロード/画像なしidなし</pre>
                            </label><br>
                            <div class="hidden_field">
                              <%= sif.file_field :store_image, id: :store_img_field_0, multiple: true %>
                              <%= sif.file_field :store_image, id: :store_img_field_1, multiple: true %>
                              <%= sif.file_field :store_image, id: :store_img_field_2, multiple: true %>
                              <%= sif.file_field :store_image, id: :store_img_field_3, multiple: true %>
                              <%= sif.file_field :store_image, id: :store_img_field_4, multiple: true %>
                            </div>
                            <hr>
                          </di>
                        </div>
                      <% end %>
                  <% end %>
                <% else %>
                  <%= sf.fields_for :store_images do |sif| %>
                    <div class="post__drop__box__container">
                      <div class="prev-content"></div>
                      <div class="label-content">
                        <label class="label-box" for="store_img_field_0" id="label-box--0">
                          <pre class="label-box__text-visible">クリックしてファイルをアップロード/画像あり更新</pre>
                        </label><br>
                        <div class="hidden_field">
                          <%= sif.file_field :store_image, id: :store_img_field_0, multiple: true %>
                          <%= sif.file_field :store_image, id: :store_img_field_1, multiple: true %>
                          <%= sif.file_field :store_image, id: :store_img_field_2, multiple: true %>
                          <%= sif.file_field :store_image, id: :store_img_field_3, multiple: true %>
                          <%= sif.file_field :store_image, id: :store_img_field_4, multiple: true %>
                        </div>
                        <span class="image_notice">※画像の更新をする場合は添付する画像を選択してください。</span>
                        <div class="field mt-3">
                          <%= sif.check_box :remove_store_image %>&ensp;画像の削除</span>
                          <p class="image_notice">※画像を削除する場合はチェックボックスにチェックを入れてください。</p>
                        </div>
                      </div>
                    </div>
                  <% end %>
                <% end %>
              </div>

              <!-- プレビュー -->
              <div class="prev-content">
                <div class="label-content"></div>
              </div>




              <div class="field mt-3">
                <% unless @store.store_images.pluck(:sm_image).any? %>
                  <% if @store.store_images.where(sm_image: nil).present? %>
                    <%= sf.fields_for :store_images do |sif| %>
                      <%= sif.label :sm_image, class:"mr-2" %><br>
                      <%= sif.file_field :sm_image, multiple: true %><br>
                    <% end %>
                  <% else %>
                      <%= sf.fields_for :store_images, @store.store_images.build do |sif| %>
                        <%= sif.label :sm_image, class:"mr-2" %><br>
                        <%= sif.file_field :sm_image, multiple: true %>
                      <% end %>
                  <% end %>
                <% else %>
                  <%= sf.fields_for :store_images do |sif| %>
                    <%= sif.label :sm_image, class:"mr-2" %><br>
                    <%= sif.file_field :sm_image, multiple: true %><br>
                    <span class="image_notice">※画像の更新をする場合は添付する画像を選択してください。</span>
                    <div class="field mt-3">
                      <%= sif.check_box :remove_sm_image %>&ensp;画像の削除</span>
                      <p class="image_notice">※画像を削除する場合はチェックボックスにチェックを入れてください。</p>
                    </div>
                  <% end %>
                <% end %>
              </div>
            <div class="actions mt-5 text-center">
              <%= sf.submit "更新", class:"btn btn-primary w-75" %>
            </div>
            <% end %>
          </div>
        </div>
      <%= link_to "キャンセル", store_managers_show_path(current_store_manager), class:"top_space" %>
      <%= link_to "top", root_path %>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>

"
<script>
//プレビューのhtmlを定義
function buildHTML(count) {
  var html = `<div class="preview-box" id="preview-box__${count}">
                <div class="upper-box">
                  <img src="" alt="preview">
                </div>
                <div class="lower-box">

                  <div class="delete-box" id="delete_btn_${count}">
                    <span>削除</span>
                  </div>
                </div>
              </div>`
  return html;
}

// ラベルのwidth操作
function setLabel() {
  //プレビューボックスのwidthを取得し、maxから引くことでラベルのwidthを決定
  var prevContent = $('.label-content').prev();
  labelWidth = (620 - $(prevContent).css('width').replace(/[^0-9]/g, ''));
  $('.label-content').css('width', labelWidth);
}

//ファイル要素が変更されるたびに発火
jQuery(document).on('change', 'input[type=file]', function (event) {
  //hidden-fieldのidの数値のみ取得
    var id = $(this).attr('id').replace(/[^0-9]/g, '');
  //選択したfileのオブジェクトを取得
    var file = this.files[0];
    var reader = new FileReader();
  //readAsDataURLで指定したFileオブジェクトを読み込む
    reader.readAsDataURL(file);

    reader.onload = function() {
    var image = this.result;
    //プレビューが元々なかった場合はhtmlを追加
        if ($(`#preview-box__${id}`).length == 0) {
          var count = $('.preview-box').length;
          var html = buildHTML(id);
          //ラベルの直前のプレビュー群にプレビューを追加
          var prevContent = $('.label-content').prev();
          $(prevContent).append(html);
        }
        //イメージを追加
        $(`#preview-box__${id} img`).attr('src', `${image}`);
        var count = $('.preview-box').length;
        //プレビューが5個あったらラベルを隠す
        if (count == 5) {
          $('.label-content').hide();
        }
        //ラベルのwidth操作
        setLabel();
        //ラベルのidとforの値を変更
        if(count < 5){
          //プレビューの数でラベルのオプションを更新する
          $('.label-box').attr({id: `label-box--${count}`,for: `store_img_field_${count}`});
        }
    }
    // 画像の削除
    $(document).on('click', '.delete-box', function() {
      var count = $('.preview-box').length;
      setLabel(count);
      //item_images_attributes_${id}_image から${id}に入った数字のみを抽出
      var id = $(this).attr('id').replace(/[^0-9]/g, '');
      //取得したidに該当するプレビューを削除
      $(`#preview-box__${id}`).remove();
      console.log("new")
      //フォームの中身を削除
      $(`#item_images_attributes_${id}_image`).val("");

      //削除時のラベル操作
      var count = $('.preview-box').length;
      //5個めが消されたらラベルを表示
      if (count == 4) {
        $('.label-content').show();
      }
      setLabel(count);

      if(id < 5){
        //削除された際に、空っぽになったfile_fieldをもう一度入力可能にする
        $('.label-box').attr({id: `label-box--${id}`,for: `store_img_field_${id}`});
      }
    });
});



</script>
